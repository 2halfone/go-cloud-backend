name: Deploy to VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to VM
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'ENDSSH'
          set -e
          
          cd /home/${{ secrets.USERNAME }}
          
          rm -rf go-cloud-backend
          git clone https://github.com/${{ github.repository }}.git go-cloud-backend
          cd go-cloud-backend          cat > .env << EOF
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOF
          
          docker-compose -f docker-compose.prod.yml down || true
          docker rmi golang:1.21-alpine || true
          docker rmi $(docker images 'go-cloud-backend*' -q) || true
          docker system prune -f
          docker pull golang:1.23-alpine
          docker-compose -f docker-compose.prod.yml build --no-cache --pull
          docker-compose -f docker-compose.prod.yml up -d
          
          sleep 30
          curl -f http://localhost:3000/health
          echo "âœ… Deployment completed!"
        ENDSSH
